
echo "Initial run"
$NXF_RUN -print-output --save_bam_bai | tee stdout

[[ $(grep INFO .nextflow.log | grep -c 'Submitted process > fastqc') == 3 ]] || false
[[ $(grep INFO .nextflow.log | grep -c 'Submitted process > align') == 3 ]] || false
[[ $(grep INFO .nextflow.log | grep -c 'Submitted process > quant') == 3 ]] || false
sed "s|"$(dirname "$(realpath "$0")")"||g" stdout > stdout.norm
cmp .expected stdout.norm || false

[[ -f results/log/alpha.fastqc.log ]] || false
[[ -f results/log/beta.fastqc.log ]] || false
[[ -f results/log/delta.fastqc.log ]] || false
[[ -f results/align/alpha.bai ]] || false
[[ -f results/align/alpha.bam ]] || false
[[ -f results/align/beta.bai ]] || false
[[ -f results/align/beta.bam ]] || false
[[ -f results/align/delta.bai ]] || false
[[ -f results/align/delta.bam ]] || false
[[ -L results/quant/alpha ]] || false
[[ -L results/quant/beta ]] || false
[[ -L results/quant/delta ]] || false
[[ -f results/samples.csv ]] || false
[[ -f results/summary_report.html ]] || false
[[ -f results/summary_data/data.json ]] || false
[[ -f results/summary_data/fastqc.txt ]] || false


echo "Run again with overwrite enabled"
$NXF_RUN --save_bam_bai | tee stdout

[[ $(grep INFO .nextflow.log | grep -c 'Submitted process > fastqc') == 3 ]] || false
[[ $(grep INFO .nextflow.log | grep -c 'Submitted process > align') == 3 ]] || false
[[ $(grep INFO .nextflow.log | grep -c 'Submitted process > quant') == 3 ]] || false

[[ -f results/log/alpha.fastqc.log ]] || false
[[ -f results/log/beta.fastqc.log ]] || false
[[ -f results/log/delta.fastqc.log ]] || false
[[ -f results/align/alpha.bai ]] || false
[[ -f results/align/alpha.bam ]] || false
[[ -f results/align/beta.bai ]] || false
[[ -f results/align/beta.bam ]] || false
[[ -f results/align/delta.bai ]] || false
[[ -f results/align/delta.bam ]] || false
[[ -L results/quant/alpha ]] || false
[[ -L results/quant/beta ]] || false
[[ -L results/quant/delta ]] || false
[[ -f results/samples.csv ]] || false
[[ -f results/summary_report.html ]] || false
[[ -f results/summary_data/data.json ]] || false
[[ -f results/summary_data/fastqc.txt ]] || false


echo "Run with some outputs disabled"
rm -rf results

$NXF_RUN -resume | tee stdout

[[ $(grep INFO .nextflow.log | grep -c 'Cached process > fastqc') == 3 ]] || false
[[ $(grep INFO .nextflow.log | grep -c 'Cached process > align') == 3 ]] || false
[[ $(grep INFO .nextflow.log | grep -c 'Cached process > quant') == 3 ]] || false

[[ -f results/log/alpha.fastqc.log ]] || false
[[ -f results/log/beta.fastqc.log ]] || false
[[ -f results/log/delta.fastqc.log ]] || false
[[ ! -e results/align ]] || false
[[ -L results/quant/alpha ]] || false
[[ -L results/quant/beta ]] || false
[[ -L results/quant/delta ]] || false
[[ -f results/samples.csv ]] || false
[[ -f results/summary_report.html ]] || false
[[ -f results/summary_data/data.json ]] || false
[[ -f results/summary_data/fastqc.txt ]] || false


echo "Resumed run"
rm -rf results

$NXF_RUN --save_bam_bai -resume | tee stdout

[[ $(grep INFO .nextflow.log | grep -c 'Cached process > fastqc') == 3 ]] || false
[[ $(grep INFO .nextflow.log | grep -c 'Cached process > align') == 3 ]] || false
[[ $(grep INFO .nextflow.log | grep -c 'Cached process > quant') == 3 ]] || false

[[ -f results/log/alpha.fastqc.log ]] || false
[[ -f results/log/beta.fastqc.log ]] || false
[[ -f results/log/delta.fastqc.log ]] || false
[[ -f results/align/alpha.bai ]] || false
[[ -f results/align/alpha.bam ]] || false
[[ -f results/align/beta.bai ]] || false
[[ -f results/align/beta.bam ]] || false
[[ -f results/align/delta.bai ]] || false
[[ -f results/align/delta.bam ]] || false
[[ -L results/quant/alpha ]] || false
[[ -L results/quant/beta ]] || false
[[ -L results/quant/delta ]] || false
[[ -f results/samples.csv ]] || false
[[ -f results/summary_report.html ]] || false
[[ -f results/summary_data/data.json ]] || false
[[ -f results/summary_data/fastqc.txt ]] || false
