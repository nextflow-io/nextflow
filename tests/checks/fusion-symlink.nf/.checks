#!/bin/bash

# Skip test if AWS keys are missing
if [ -z "$AWS_ACCESS_KEY_ID" ]; then 
  echo "Missing AWS credentials -- Skipping test"
  exit 0
fi

#
# normal run
#
echo initial run
$NXF_RUN -c .config
RUN_ID=$($NXF_CMD log | tail -n1 | awk '{ print $7 }')

$NXF_CMD fs cp "s3://nextflow-ci/work/ci-test/fusion-symlink/${RUN_ID}/data.txt" data.txt
cmp data.txt .expected || false

#
# resume run
#
echo resumed run
$NXF_RUN -c .config -resume

$NXF_CMD fs cp "s3://nextflow-ci/work/ci-test/fusion-symlink/${RUN_ID}/data.txt" data.txt
cmp data.txt .expected || false
