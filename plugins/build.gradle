import io.nextflow.gradle.tasks.GithubRepositoryPublisher
import org.apache.commons.codec.digest.DigestUtils
apply plugin: 'java'

ext.aws_access_key_id = project.findProperty('aws_access_key_id') ?: System.getenv('AWS_ACCESS_KEY_ID')
ext.aws_secret_access_key = project.findProperty('aws_secret_access_key') ?: System.getenv('AWS_SECRET_ACCESS_KEY')
ext.publishRepoUrl = project.findProperty('publish_repo_url') ?: System.getenv('PUBLISH_REPO_URL') ?: ( version.endsWith('-SNAPSHOT') ? "s3://maven.seqera.io/snapshots" : "s3://maven.seqera.io/releases" )
jar.enabled = false

subprojects {
    apply plugin: 'java'
    apply plugin: 'groovy'
    apply plugin: 'maven-publish'

    repositories {
        mavenLocal()
        mavenCentral()
    }

    group = 'io.nextflow'
    version = project.file('VERSION').text.trim()

    tasks.withType(GenerateModuleMetadata) {
        enabled = false
    }

    /*
     * Copy the plugin dependencies in the subproject `build/target/libs` directory
     */
    task copyPluginLibs(type: Sync) {
        group 'nextflow'
        from configurations.runtimeClasspath
        into 'build/target/libs'
    }

    /*
     * Copy the plugin in the project root build/plugins directory
     */
    task copyPluginZip(type: Copy, dependsOn: project.tasks.findByName('makeZip')) {
        group 'nextflow'
        from project.tasks.findByName('makeZip')
        into "$rootProject.buildDir/plugins"
        outputs.file("$rootProject.buildDir/plugins/${project.name}-${project.version}.zip")
        doLast {
            ant.unzip(
                    src: "$rootProject.buildDir/plugins/${project.name}-${project.version}.zip",
                    dest: "$rootProject.buildDir/plugins/${project.name}-${project.version}"
            )
        }
    }

    /*
    * "install" the plugin the project root build/plugins directory
    */
    project.parent.tasks.getByName("assemble").dependsOn << copyPluginZip

    jar {
        from sourceSets.main.allSource
        doLast {
            file("$buildDir/tmp/jar").deleteDir()
        }
    }

    tasks.withType(GenerateModuleMetadata) {
        enabled = false
    }

    /*
     * publish jars maven repo on S3 
     */
    publishing {
        publications {
            maven(MavenPublication) {
                from components.java
                suppressPomMetadataWarningsFor('testFixturesApiElements')
                suppressPomMetadataWarningsFor('testFixturesRuntimeElements')
            }
        }
        repositories {
            maven {
                url = System.getenv('MAVEN_PUBLISH_URL') ?: 's3://maven.seqera.io'
                url = version.endsWith('-SNAPSHOT') ? "$url/snapshots" : "$url/releases"

                credentials(AwsCredentials) {
                    accessKey = System.getenv('AWS_ACCESS_KEY_ID') ?: findProperty('aws_access_key_id')
                    secretKey = System.getenv('AWS_SECRET_ACCESS_KEY') ?: findProperty('aws_secret_access_key')
                }
            }
        }
    }
}

/**
 * Publish jars to maven repositories
 */
task publishPluginsToMaven {
    dependsOn subprojects.publish
}
/*
 * "install" the plugin the project root build/plugins directory
 */
project.parent.tasks.getByName("assemble").dependsOn << assemble

/*
 * Copies the plugins required dependencies in the corresponding lib directory
 */
classes.dependsOn subprojects.copyPluginLibs

task publishIndex( type: GithubRepositoryPublisher ) {
    indexUrl = System.getenv('PLUGINS_INDEX_JSON') ?: 'https://github.com/nextflow-io/plugins/main/plugins.json'
    repos = allPlugins()
    owner = System.getenv('GH_ORG') ?: 'nextflow-io'
    githubUser = System.getenv('GH_USER') ?: project.findProperty('github_username')
    githubEmail = System.getenv('GH_USER_EMAIL') ?: project.findProperty('github_commit_email')
    githubToken = System.getenv('GH_TOKEN') ?: project.findProperty('github_access_token')
}
