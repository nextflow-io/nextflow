#!/bin/bash
su - !{userName} << 'EndOfScript'
(
set -e
set -x

mkdir -p $HOME/.nextflow
cat <<EOF >> $HOME/.nextflow/config
!{nextflowConfig}
EOF

mkdir -p $HOME/bin
profile=$(mktemp)
cat <<EOF > $profile
!{bashProfile}
EOF

source $profile
cat $profile >> $HOME/.bash_profile
rm $profile

#
# set instance name
#
instance="$(curl -s http://169.254.169.254/latest/meta-data/instance-id)"
zone="$(curl -s 169.254.169.254/latest/meta-data/placement/availability-zone)"
region="${zone::-1}"

#
# Launch docker and pull the container when DOCKER variable is defined
#
[[ '!{dockerPull}' ]] && for x in '!{dockerPull}'; do docker pull $x || true; done

#
# Mount fsx file systems if provided
#
mountCommandsString="!{fsxFileSystemsMountCommands}"
IFS=';' read -ra mountCommandsArray <<< "$mountCommandsString"
[[ '!{fsxFileSystemsMountCommands}' ]] && for fsxMountCommand in "${mountCommandsArray[@]}"; do $fsxMountCommand || true; done

#
# Install NEXTFLOW and launch it
#
if [[ '!{customNextflowBinaryUrl}' ]]; then
  curl -s https://get.nextflow.io --output nextflow
  NXF_PACK="all" NXF_URL="!{customNextflowBinaryUrl}" NXF_VER=${version} NXF_MODE="ignite" NXF_EXECUTOR="ignite" bash nextflow info
  chmod +x $HOME/nextflow
  $HOME/nextflow -download
fi

# pull the nextflow pipeline repo
[[ '!{nextflow.pull}' ]] && $HOME/nextflow pull '!{nextflow.pull}'

# launch the nextflow daemon
if [[ '!{role}' == worker ]]; then
  $HOME/nextflow node -cluster.join "$NXF_CLUSTER_JOIN" -cluster.interface eth0 -bg
fi

# save the environment for debugging
env | sort > boot.env

# just a marker file
touch READY

) &> ~!{userName}/boot.log
EndOfScript
